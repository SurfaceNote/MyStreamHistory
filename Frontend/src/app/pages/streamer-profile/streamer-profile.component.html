<main>
    <div class="wrapper">
        <div class="gray-main-block">
            <div class="stream-page-main-content">
                <div class="profile">
                    <div class="poster">
                        <img src="{{ streamerShortDTO.avatar }}" alt="logo channel {{ streamerShortDTO.displayName }}">
                    </div>
                    <div class="meta">
                        <div class="profile">
                            <span>{{ streamerShortDTO.displayName }}</span>
                            <div class="socials-list">
                                <a href="https://www.twitch.tv/{{ streamerShortDTO.displayName }}">
                                    <div class="social-link twitch-background"><i class="fa-brands fa-twitch"></i></div>
                                </a>
                                <a href="#">
                                    <div class="social-link youtube-background"><i class="fa-brands fa-youtube"></i>
                                    </div>
                                </a>
                                <a href="#">
                                    <div class="social-link instagram-background"><i class="fa-brands fa-instagram"></i>
                                    </div>
                                </a>
                                <a href="#">
                                    <div class="social-link steam-background"><i class="fa-brands fa-steam"></i></div>
                                </a>
                            </div>
                        </div>
                        <div class="meta-stream-item">
                            <span>Made</span>
                            <span><b>{{ recentStreams.length }}</b> streams</span>
                        </div>
                        <div class="meta-stream-item">
                            <span>Finished</span>
                            <span><b>20</b> games</span>
                        </div>
                        <div class="meta-stream-item">
                            <span>Streamed</span>
                            <span><b>350</b> hours</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="schedule-list-wrapper">
                <div class="schedule-list-header">
                    <span>Scheduled Streams</span>
                </div>
                <div class="schedule-list">
                    <div class="elements">
                        <div class="day">
                            <div class="header">
                                <span>Thu, 23 Nov (Test)</span>
                            </div>
                            <div class="scheduled-game-wrapper">
                                <div class="scheduled-game-info">
                                    <div class="scheduled-game">
                                        <img src="https://static-cdn.jtvnw.net/ttv-boxart/512953_IGDB-130x180.jpg">
                                        <span>Elden Ring</span>
                                    </div>
                                </div>
                                <div class="time">
                                    <span>23:30 PM</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="schedule-next-button">
                    <span>></span>
                </div>
            </div>
        </div>

        <div class="recent-streams-section">
            <div class="block-title">
                <div class="start-line"></div>
                <h3>Recent Streams ({{ recentStreams.length }})</h3>
                <div class="end-line"></div>
            </div>
            
            @if (isLoadingStreams) {
                <div style="padding: 2rem; text-align: center;">
                    <p>Loading streams...</p>
                </div>
            }
            
            @if (!isLoadingStreams && recentStreams.length === 0) {
                <div style="padding: 2rem; text-align: center;">
                    <p>No recent streams found</p>
                </div>
            }
            
            @if (!isLoadingStreams && recentStreams.length > 0) {
                <div class="streams-list-wrapper">
                    <div class="streams-list-horizontal">
                        @for (stream of recentStreams; track stream.id) {
                            <div class="stream-card" (click)="navigateToStreamDetail(stream.id)" style="cursor: pointer;">
                                <div class="stream-header">
                                    <div class="stream-status">
                                        @if (stream.isLive) {
                                            <span class="badge live">LIVE</span>
                                        } @else {
                                            <span class="badge offline">ENDED</span>
                                        }
                                    </div>
                                    <div class="stream-date">
                                        <span>{{ formatDate(stream.startedAt) }}</span>
                                    </div>
                                </div>
                                
                                <div class="stream-content">
                                    <div class="stream-categories">
                                        @if (stream.categories && stream.categories.length > 0) {
                                            <div class="categories-row">
                                                @for (category of stream.categories; track category.twitchId) {
                                                    <div class="category-box-art">
                                                        <img [src]="getCategoryBoxArt(category.boxArtUrl, 52, 72)" 
                                                             [alt]="category.name"
                                                             [title]="category.name">
                                                    </div>
                                                }
                                            </div>
                                        } @else if (stream.gameName) {
                                            <span class="game-name-fallback">{{ stream.gameName }}</span>
                                        } @else {
                                            <span class="game-name no-game">No category</span>
                                        }
                                    </div>
                                    
                                    @if (stream.streamTitle) {
                                        <div class="stream-title">
                                            <span>{{ stream.streamTitle }}</span>
                                        </div>
                                    }
                                    
                                    <div class="stream-stats">
                                        <div class="stat-item">
                                            <i class="fa-regular fa-clock"></i>
                                            <span>{{ formatDuration(stream.startedAt, stream.endedAt) }}</span>
                                        </div>
                                        @if (stream.isLive && stream.viewerCount !== null && stream.viewerCount !== undefined) {
                                            <div class="stat-item">
                                                <i class="fa-regular fa-eye"></i>
                                                <span>{{ stream.viewerCount }} viewers</span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        <div class="gray-main-block list-walkthrough-and-viewers">
            <div class="list-walkthrough">

                <div class="block-title">
                    <div class="start-line"></div>
                    <h3>In Progress (3)</h3>
                    <div class="end-line"></div>
                </div>
                <div class="games-table">
                    <div class="table-head hide-mobile">
                        <div class="head-game">
                            <span>GAME</span>
                        </div>
                        <div class="fixed-width">
                            <div><span>First Stream</span></div>
                            <div><span>Last Stream</span></div>
                            <div><span>Duration</span></div>
                            <div><span>Unique viewers</span></div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/511224-285x380.jpg"
                                    alt="Poster Apex Legends">
                                <span>Apex Legends</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32399-285x380.jpg"
                                    alt="Poster Counter-Strike">
                                <span>Counter-Strike</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32982_IGDB-285x380.jpg"
                                    alt="Poster Grand Theft Auto V">
                                <span>Grand Theft Auto V</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="block-title">
                    <div class="start-line"></div>
                    <h3>Finished (3)</h3>
                    <div class="end-line"></div>
                </div>
                <div class="games-table">
                    <div class="table-head hide-mobile">
                        <div class="head-game">
                            <span>GAME</span>
                        </div>
                        <div class="fixed-width">
                            <div><span>First Stream</span></div>
                            <div><span>Last Stream</span></div>
                            <div><span>Duration</span></div>
                            <div><span>Unique viewers</span></div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/511224-285x380.jpg"
                                    alt="Poster Apex Legends">
                                <span>Apex Legends</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32399-285x380.jpg"
                                    alt="Poster Counter-Strike">
                                <span>Counter-Strike</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32982_IGDB-285x380.jpg"
                                    alt="Poster Grand Theft Auto V">
                                <span>Grand Theft Auto V</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="block-title">
                    <div class="start-line"></div>
                    <h3>Abandoned (3)</h3>
                    <div class="end-line"></div>
                </div>
                <div class="games-table">
                    <div class="table-head hide-mobile">
                        <div class="head-game">
                            <span>GAME</span>
                        </div>
                        <div class="fixed-width">
                            <div><span>First Stream</span></div>
                            <div><span>Last Stream</span></div>
                            <div><span>Duration</span></div>
                            <div><span>Unique viewers</span></div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/511224-285x380.jpg"
                                    alt="Poster Apex Legends">
                                <span>Apex Legends</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32399-285x380.jpg"
                                    alt="Poster Counter-Strike">
                                <span>Counter-Strike</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32982_IGDB-285x380.jpg"
                                    alt="Poster Grand Theft Auto V">
                                <span>Grand Theft Auto V</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>01.01.2025</span></div>
                                <div><span>31.01.25</span></div>
                                <div><span>105 h.</span></div>
                                <div><span>32</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="block-title">
                    <div class="start-line"></div>
                    <h3>Without category (3)</h3>
                    <div class="end-line"></div>
                </div>
                <div class="games-table">
                    <div class="table-head hide-mobile">
                        <div class="head-game">
                            <span>GAME</span>
                        </div>
                        <div class="fixed-width">
                            <div><span>Duration</span></div>
                        </div>
                    </div>
                    <div class="table-body">
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/511224-285x380.jpg"
                                    alt="Poster Apex Legends">
                                <span>Apex Legends</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>105 h.</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32399-285x380.jpg"
                                    alt="Poster Counter-Strike">
                                <span>Counter-Strike</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>105 h.</span></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="game">
                                <img src="https://static-cdn.jtvnw.net/ttv-boxart/32982_IGDB-285x380.jpg"
                                    alt="Poster Grand Theft Auto V">
                                <span>Grand Theft Auto V</span>
                            </div>
                            <div class="fixed-width hide-mobile">
                                <div><span>105 h.</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="viewers-list" style="margin-right: 1rem">
                <div class="header">
                    <span><b>TOP-100 Viewers ({{ topViewers.length }})</b></span>
                </div>

                @if (isLoadingViewers) {
                    <div style="padding: 2rem; text-align: center;">
                        <p>Loading viewers...</p>
                    </div>
                }

                @if (!isLoadingViewers && topViewers.length === 0) {
                    <div style="padding: 2rem; text-align: center;">
                        <p>No viewers data yet</p>
                    </div>
                }

                @if (!isLoadingViewers && topViewers.length > 0) {
                    <div class="list">
                        @for (viewer of topViewers; track viewer.id; let i = $index) {
                            <div class="viewer-row">
                                <div class="number">
                                    <span>{{ i + 1 }}</span>
                                </div>
                                <img class="channel-logo"
                                    [src]="viewer.viewer?.profileImageUrl || getDefaultAvatar()"
                                    [alt]="viewer.viewer?.displayName + '\'s avatar'">
                                <div class="meta">
                                    <div class="nickname">
                                        <span>{{ viewer.viewer?.displayName || 'Unknown' }}</span>
                                    </div>
                                    <div class="stats">
                                        <div class="stat-item">
                                            <span><b>{{ formatHours(viewer.minutesWatched) }}</b></span>
                                        </div>
                                        <div class="stat-item">
                                            <span><b>{{ formatMessagePoints(viewer.earnedMsgPoints) }}</b> msg pts</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <script>
        function addCheckboxEventHandlers() {
            var checkboxes = document.querySelectorAll('.stream-profile-category input[type="checkbox"]');

            checkboxes.forEach(function (checkbox) {
                checkbox.addEventListener('change', function () {
                    var category = checkbox.name;
                    var person = checkbox.value;
                    console.log(person);
                    var streamId = checkbox.closest('.stream-profile').getAttribute('data-stream-id');
                    console.log(streamId);
                    var personsBlock = document.getElementById('stream-persons-' + streamId);
                    console.log(personsBlock);

                    if (checkbox.checked) {
                        var imageUrl = checkbox.getAttribute('data-image');

                        console.log(imageUrl);

                        var personsBlock = document.getElementById('stream-persons-' + streamId);
                        console.log(personsBlock);
                        if (personsBlock.hasChildNodes()) {
                            personsBlock.innerHTML += '<img src="' + imageUrl + '" style="vertical-align: middle;" width="20" height="20">';
                        } else {
                            personsBlock.innerHTML = '<img src="' + imageUrl + '" style="vertical-align: middle;" width="20" height="20">';
                        }


                    } else {
                        var imageUrl = checkbox.getAttribute('data-image');
                        var contentToRemove = personsBlock.querySelector('img[src="' + imageUrl + '"]');
                        if (contentToRemove) {
                            personsBlock.removeChild(contentToRemove);
                        }
                    }
                });
            });
        }


        document.addEventListener("DOMContentLoaded", function () {
            var openModalLinks = document.querySelectorAll(".open-modal");

            openModalLinks.forEach(function (link) {
                link.addEventListener("click", function (e) {
                    e.preventDefault();
                    var itemId = link.getAttribute("data-item-id");
                    var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/get-stream-data/", true);
                    xhr.setRequestHeader("Content-Type", "application/json");
                    xhr.setRequestHeader("X-CSRFToken", csrfToken);

                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === XMLHttpRequest.DONE) {
                            if (xhr.status === 200) {
                                var response = JSON.parse(xhr.responseText);
                                var modal = document.getElementById("modal");
                                var modalContent = modal.querySelector("#modal-content");

                                modalContent.innerHTML = response.data;

                                modal.style.display = "block";

                                var form = modal.firstElementChild;
                                console.log(form);
                                form.action = "/stream/" + itemId + "/settings/";

                                addCheckboxEventHandlers();

                            } else {
                                console.log("Error with getting data");
                            }
                        }
                    };

                    var requestData = JSON.stringify({ item_id: itemId });

                    xhr.send(requestData);
                });
            });

            var closeModalButtons = document.querySelectorAll(".close-modal");

            closeModalButtons.forEach(function (button) {
                button.addEventListener("click", function (e) {
                    e.preventDefault();
                    var modal = document.getElementById("modal");
                    modal.style.display = "none";
                });
            });

            var forms = document.querySelectorAll('.django-form');

            forms.forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    event.preventDefault();
                    var formData = new FormData(form);

                    fetch(form.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                        .then(function (response) {
                            if (response.ok) {
                                var modal = document.getElementById("modal");
                                var modalContent = modal.querySelector("#modal-content");
                                var formResult = document.createElement("p");
                                formResult.style.color = "green";
                                formResult.textContent = "Form submitted successfully";

                                modalContent.appendChild(formResult);

                            } else {
                                console.log("Error wile sending a form");
                            }
                        })
                        .catch(function (error) {
                            console.log("Error wile sending a form: " + error.message);
                        });
                });
            });
        });
    </script>
</main>